---
title: "Release v0.2.0: NocoDB Integration & Authentication System"
date: 2025-12-25
authors:
  - Team
category: Milestone
tags:
  - Release
  - v0.1.0
  - Production
summary: "Production-ready release featuring NocoDB integration for Content and Authentication, & Authentication System. Major Refactors of content architecture."
---

# Dark Matter v0.2.0 Release Notes

**Release Date:** December 26, 2025
**Tag:** v0.2.0
**Previous Release:** v0.1.1

---

## Overview

This major release transforms Dark Matter from a static marketing site into a dynamic, data-driven platform with cloud database integration, multi-tier authentication, and a comprehensive content architecture for investor communications.

---

## 1. NocoDB Integration

### What is NocoDB?

NocoDB is an open-source Airtable alternative that provides a spreadsheet-like interface for managing relational data. We use a cloud-hosted NocoDB instance as the single source of truth for portfolio company data, investor access control, and session tracking.

### API Client (`src/lib/nocodb.ts`)

A complete TypeScript client for NocoDB's v3 API:

**Core Functions:**
| Function | Purpose |
|----------|---------|
| `fetchRecords<T>()` | Single fetch with query params (where, limit, offset, sort, fields) |
| `fetchAllRecords<T>()` | Auto-paginating fetch for datasets exceeding page limits |
| `getPortfolioCompanies()` | Fetches organizations filtered by "Portfolio Page" inclusion |
| `transformToPortfolioCompanies()` | Converts NocoDB records to render-ready format |
| `checkEmailAccess()` | Validates email against allowlist and session history |
| `createEmailAccessSession()` | Records new access session with audit timestamp |
| `updateSessionHeartbeat()` | Updates rolling "last seen" timestamp |

**Caching Layer:**
- 5-minute TTL in-memory cache
- Reduces API calls during development and build processes
- Cache key based on table ID and query parameters

**Graceful Degradation:**
- Returns empty results if API is unavailable or misconfigured
- Logs warnings without crashing the build
- Allows static fallback data for development without credentials

**Configuration:**
```bash
NOCODB_API_KEY=your-api-key
NOCODB_BASE_URL=https://app.nocodb.com  # default
NOCODB_BASE_ID=your-base-id
```

### Type System

```typescript
interface OrganizationFields {
  conventionalName: string;
  officialName: string;
  'Entity-Type'?: string | null;
  trademarksSlugs?: TrademarksSlugs | string | null;  // JSON field
  elevatorPitch?: string | null;
  logoMinWidth?: string | null;
  includeIn?: string[] | null;  // Multi-select field
}

interface PortfolioCompany {
  conventionalName: string;
  officialName: string;
  entityType: string;
  logoLightMode: string;
  logoDarkMode: string;
  logoVibrantMode: string;
  logoIsTransparent: boolean;
  logoMinWidth: string;
  urlToPortfolioSite: string;
  blurbShortTxt: string;
  category: 'direct' | 'lp';
}
```

---

## 2. Authentication System

### Architecture Overview

Three authentication methods serve different use cases:

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Passcode      │     │     Email       │     │  Temp Access    │
│   (Investors)   │     │   (Partners)    │     │   (Prospects)   │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Middleware Protection                         │
│         /portfolio/confidential, /pipeline/confidential, /memos │
└─────────────────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Session Heartbeat Tracking                     │
│              3-minute intervals, visibility-aware                │
└─────────────────────────────────────────────────────────────────┘
```

### Method 1: Passcode Authentication

**File:** `src/pages/api/verify-portfolio-passcode.ts`

For investors with the universal access passcode.

**Security:**
- Development: plaintext comparison via `UNIVERSAL_PORTFOLIO_PASSCODE_PLAINTEXT`
- Production: SHA256 hash comparison with salt via `UNIVERSAL_PORTFOLIO_PASSCODE_HASH` + `UNIVERSAL_PORTFOLIO_PASSCODE_SALT`

**Session:**
- Sets `universal_portfolio_access` cookie
- 24-hour expiration
- httpOnly, secure, strict SameSite

### Method 2: Email Authentication

**File:** `src/pages/api/verify-email.ts`

For partners and known contacts with two-tier approval:

**Tier 1 - Domain Allowlist:**
Auto-approved domains (configurable via env):
- `darkmatter.vc`
- `darkmatterlongevity.com`
- `lossless.group`

**Tier 2 - Session History:**
Emails with previous access sessions in NocoDB are automatically approved.

**Cookies Set:**
| Cookie | Purpose | HttpOnly |
|--------|---------|----------|
| `universal_portfolio_access` | Session token | Yes |
| `accessor_email` | User tracking | Yes |
| `session_record_id` | Heartbeat reference | No (client needs access) |

**Audit Trail:**
All access requests (approved or denied) are logged to NocoDB `emailAccess` table with:
- Email address
- Access timestamp
- Approval status
- Session ID

### Method 3: Temporary Access

**File:** `src/pages/api/verify-temp-access.ts`

For prospects who want quick access without approval workflow.

- Triggered via modal on `/portfolio-gate`
- Captures email to NocoDB for follow-up
- Grants immediate 24-hour access
- Same cookie structure as email auth

### Route Protection

**File:** `src/middleware.ts`

Protected routes:
- `/portfolio/confidential`
- `/pipeline/confidential`
- `/memos`

Behavior:
1. Check for `universal_portfolio_access` cookie
2. If missing, redirect to `/portfolio-gate?redirect=<original-path>`
3. After successful auth, redirect back to original destination

### Session Heartbeat Tracking

**Component:** `src/components/auth/SessionHeartbeat.astro`
**API:** `src/pages/api/session-heartbeat.ts`

Passive session duration tracking:

- Sends heartbeat every 3 minutes while page is visible
- Pauses when tab is hidden (Visibility API)
- Resumes when tab regains focus
- Sends final heartbeat on page unload via `sendBeacon`
- No external dependencies (vanilla JS)

**NocoDB Updates:**
- `sessionEndTime` updated as rolling timestamp
- Session duration = `sessionEndTime - sessionStartTime`

### Gate Page UI

**File:** `src/pages/portfolio-gate.astro`

- Tabbed interface: Passcode / Email switching
- Error states: invalid, invalid-email, pending
- Modal for temporary access requests
- Mode-responsive styling (light/dark/vibrant)
- Preserves redirect URL through authentication flow

---

## 3. Portfolio Page

### Public Portfolio (`/portfolio`)

**File:** `src/pages/portfolio/index.astro`

- **Prerendered** at build time for performance
- Fetches from NocoDB if configured, falls back to static JSON
- Displays:
  - Direct investments (filtered by `entityType`)
  - LP commitments (fund-of-fund positions)
- Mode-aware logo rendering (light/dark/vibrant)
- CTA linking to confidential portfolio

**Data Source Hierarchy:**
1. NocoDB API (if `NOCODB_API_KEY` configured)
2. Static JSON fallback (`src/content/portfolio/portfolio-companies.json`)

### Confidential Portfolio (`/portfolio/confidential`)

**File:** `src/pages/portfolio/confidential/index.astro`

- **Server-rendered** (not prerendered) for access control
- Protected by middleware authentication
- Includes `SessionHeartbeat` component for view tracking
- Additional data displayed:
  - Team members for each company
  - Links to investment memos (`/memos/{slug}`)
  - `AuthenticationStatus` component showing login level

### Logo Handling

Sophisticated multi-mode logo system:

```typescript
// Logo paths constructed from NocoDB trademarksSlugs field
logoLightMode: `/logos/${slug}/logo-light.svg`
logoDarkMode: `/logos/${slug}/logo-dark.svg`
logoVibrantMode: `/logos/${slug}/logo-vibrant.svg`
```

**Transparent Logo Detection:**
- Parses `trademarksSlugs` JSON for `isTransparent` flag
- Applies CSS filter (brightness/invert) for theme compatibility
- Prevents washed-out logos on matching backgrounds

**Minimum Width Enforcement:**
- `logoMinWidth` field from NocoDB
- Prevents small/detailed logos from becoming illegible

**Dual Image Rendering:**
- Renders both light and dark variants in DOM
- Shows/hides via CSS based on active mode
- Instant switching without JavaScript

---

## 4. Changelog System

### Three View Layouts

A single data source with multiple presentation options:

#### Timeline View (Default)

**File:** `src/layouts/changelog/TimelineLayout.astro`

Linear/Stripe-inspired design:
- Vertical timeline with month groupings
- Sticky month headers
- Category badges with semantic colors
- Hover animations on timeline dots
- Responsive mobile layout

**Category Colors:**
| Category | Color |
|----------|-------|
| Feature | Emerald |
| Component | Violet |
| Refactor | Amber |
| Fix | Rose |
| Documentation | Sky |
| Infrastructure | Slate |
| Design-System | Fuchsia |
| Milestone | Amber |

#### Card Grid View

**File:** `src/layouts/changelog/CardGridLayout.astro`

Notion/Tailwind UI-inspired:
- 3-column responsive grid
- Client-side category filtering (vanilla JS)
- Gradient headers with emoji icons
- "New" badge for recent entries
- 2-line summary clamp
- Fade-in animation on filter change

#### Releases View

**File:** `src/layouts/changelog/ReleasesLayout.astro`

GitHub releases-inspired:
- Grouped by semantic version
- Full release notes display
- Download/asset links

### Index Page

**File:** `src/pages/changelog/index.astro`

- Fetches all entries from content collection
- Sorts by date (newest first), then by ID (same-date ordering)
- Groups by month for timeline view
- View toggler with URL state (`?view=timeline|cards|releases`)
- Hero header with gradient text

### Content Schema

**File:** `src/content/changelog/changelog.config.ts`

```typescript
interface ChangelogEntry {
  title: string;
  date: Date;  // required
  authors?: string[];
  category?: 'feature' | 'component' | 'refactor' | 'fix' | 'docs' | 'infra' | 'design-system' | 'milestone';
  tags?: string[];
  summary?: string;
  why_care?: string;
  files_added?: string[];
  files_modified?: string[];
  augmented_with?: string;  // AI tool attribution
}
```

---

## 5. Narrative Content Architecture

### Philosophy

Fund pitch content is organized as **reusable narrative sections** with rich metadata, citations, and multiple visual presentations. This allows:

- Single source of truth for messaging
- Version-controlled content updates
- Citation tracking for compliance
- A/B testing different section designs

### Content Structure

**Location:** `src/content/narratives/*.md`

Each narrative section is a Markdown file with extensive frontmatter:

```yaml
---
slug: aging-population
component: AgingPopulation.astro
componentPath: src/layouts/sections/narratives/AgingPopulation.astro
order: 2
category: opportunity
lastUpdated: 2024-12-18

title: The Global Aging Wave
subtitle: A demographic shift creating a multi-trillion dollar opportunity
eyebrow: Why Now

hero:
  stat: "2B"
  label: people over 60 by 2050
  source: United Nations

demographicStats:
  - stat: "2.1B"
    label: People 60+ by 2050
    description: The UN projects...
    citationKey: "1ucdcd"

citations:
  1ucdcd:
    title: "World Population Ageing 2023"
    url: "https://..."
    source: "United Nations"
    publishedDate: "2023-01-15"
---
```

### Available Sections

| Section | Category | Purpose |
|---------|----------|---------|
| `section--the-aging-crisis.md` | problem | Disease costs, prevalence data |
| `section--aging-population.md` | opportunity | Demographic trends |
| `section--dark-matter-differentiation.md` | solution | Fund positioning |
| `section--exit-potential.md` | returns | IPO/M&A pathways |
| `section--fund-portfolio-construction.md` | fund | Allocation strategy |
| `why-now-why-dark-matter.md` | thesis | Market timing |
| `market-timing.md` | thesis | Economic cycle analysis |
| `dataroom-intro.md` | confidential | Data room introduction |

### Schema Fields

**Display & Organization:**
- `slug`, `component`, `componentPath`, `order`, `category`, `lastUpdated`
- `title`, `subtitle`, `eyebrow`

**Hero Sections:**
- `hero`: Single prominent statistic with source
- `heroStats`: Array of stat cards with citations
- `heroMetrics`: Value/label/suffix metrics

**Content Arrays:**
- `diseaseCosts`: Cost data with icons and citations
- `healthspanGap`: Lifespan vs healthspan visualization
- `demographicStats`, `costImplications`, `usStats`
- `scienceBreakthroughs`: Discovery highlights

**Fund-Specific:**
- `pillars`: Differentiation pillars with team mapping
- `ipoPath`, `maPath`: Exit strategy details
- `marketGrowth`: CAGR projections
- `economics`, `geography`, `stages`, `checkSizes`, `followOnTiers`

**Citations:**
- `citations`: Record of all referenced sources
- Inline citation components reference by key

### Page Assembly

**Thesis Page:** `src/pages/thesis/index.astro`
```astro
<AgingPopulation />
<TheAgingCrisis />
<ExitPotential />
```

**Strategy Page:** `src/pages/strategy/index.astro`
```astro
<WhyNowWhyUsV5 />
<DarkMatterDifferentiation />
<FundPortfolioConstructionDetails />
```

### Section Components

Multiple versions per section for iteration:
- `WhyNowWhyUs-v1.astro` through `v7.astro`
- Variants: `vibrant/`, `needs-modes/`
- All consume data from narratives markdown frontmatter

### Citation System

**Components:** `src/components/citations/`

| Component | Purpose |
|-----------|---------|
| `Sources.astro` | Full citation list |
| `SourcesCompact.astro` | Compact citation list |
| `SourcesInline.astro` | Inline citations |
| `InlineCitation.astro` | Single citation reference |
| `CitedSection.astro` | Section wrapper with citation support |

---

## File Reference

| Component | File Path |
|-----------|-----------|
| NocoDB Client | `src/lib/nocodb.ts` |
| Passcode Auth | `src/pages/api/verify-portfolio-passcode.ts` |
| Email Auth | `src/pages/api/verify-email.ts` |
| Temp Access | `src/pages/api/verify-temp-access.ts` |
| Session Heartbeat API | `src/pages/api/session-heartbeat.ts` |
| Route Protection | `src/middleware.ts` |
| Heartbeat Component | `src/components/auth/SessionHeartbeat.astro` |
| Auth Gate Page | `src/pages/portfolio-gate.astro` |
| Public Portfolio | `src/pages/portfolio/index.astro` |
| Confidential Portfolio | `src/pages/portfolio/confidential/index.astro` |
| Timeline Layout | `src/layouts/changelog/TimelineLayout.astro` |
| Card Grid Layout | `src/layouts/changelog/CardGridLayout.astro` |
| Releases Layout | `src/layouts/changelog/ReleasesLayout.astro` |
| Changelog Index | `src/pages/changelog/index.astro` |
| Narratives Schema | `src/content/narratives/narratives.config.ts` |
| Thesis Page | `src/pages/thesis/index.astro` |
| Strategy Page | `src/pages/strategy/index.astro` |
| Narrative Content | `src/content/narratives/*.md` |

---

## Migration Notes

### From v0.1.1

No breaking changes. New features are additive.

**New Environment Variables:**
```bash
# NocoDB (optional - falls back to static data)
NOCODB_API_KEY=
NOCODB_BASE_URL=https://app.nocodb.com
NOCODB_BASE_ID=

# Authentication
UNIVERSAL_PORTFOLIO_PASSCODE_PLAINTEXT=  # dev only
UNIVERSAL_PORTFOLIO_PASSCODE_HASH=       # production
UNIVERSAL_PORTFOLIO_PASSCODE_SALT=       # production
```

**New Protected Routes:**
- `/portfolio/confidential`
- `/pipeline/confidential`
- `/memos`

---

## Contributors

- MP Staton ([@mpstaton](https://github.com/mpstaton))
- Claude Code (AI pair programming)

---

## What's Next

- Investor dashboard with portfolio analytics
- Document upload to NocoDB
- Magic link authentication
- Real-time portfolio valuation updates
